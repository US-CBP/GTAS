version: '3.7'
services:
  http-proxy:
    environment:
      BOOTSTRAP_PATH: '/run/secrets/elastic-bootstrap-password'
    secrets:
      - source: webapp-cert
        target: /temp-cert/wcogtas.org.crt
      - source: webapp-key
        target: /temp-cert/wcogtas.org.key
  web-app:
    environment:
      DB_HOST: mariadb
      BOOTSTRAP_PATH: "/run/secrets/elastic-bootstrap-password"
      MYSQL_USER_PATH: "/run/secrets/mysql-webapp-user"
      MYSQL_PASSWORD_PATH: "/run/secrets/mysql-webapp-password"
      NEO4J_USER_PATH: "/run/secrets/webapp-neo4j-user"
      NEO4J_PASSWORD_PATH: "/run/secrets/webapp-neo4j-password"
    secrets:
      - source: webapp-cert
        target: /temp-cert/wcogtas.org.crt
      - source: webapp-key
        target: /temp-cert/wcogtas.org.key
      - source: elastic-cert
        target: /temp-cert/elasticsearch-node1.crt
      - source: elastic-key
        target: /temp-cert/elasticsearch-node1.key
      - source: elastic-ca
        target: /temp-cert/elastic-ca.crt
  logstash:
    environment:
      MARIADB_HOST: mariadb
      XPACK_MONITORING_ELASTICSEARCH_SSL_CERTIFICATEAUTHORITY: /run/secrets/elastic-ca
  kibana:
    secrets:
      - source: elastic-ca
        target: /etc/kibana/config/elastic-ca.crt
      - source: kibana-crt
        target: /etc/kibana/config/kibana.crt
      - source: kibana-key
        target: /etc/kibana/config/kibana.key
  gtas-scheduler:
    environment:
      DB_HOST: mariadb
      MYSQL_USER_PATH: "/run/secrets/mysql-processor-user"
      MYSQL_PASSWORD_PATH: "/run/secrets/mysql-processor-password"
      NEO4J_USER_PATH: "/run/secrets/webapp-neo4j-user"
      NEO4J_PASSWORD_PATH: "/run/secrets/webapp-neo4j-password"
  etl-job:
    environment:
      DB_HOSTNAME: mariadb
      ENABLE_DATA_RETENTION_POLICY: "N"
      NEO4J_USER_PATH: '/run/secrets/etl-neo4j-user'
      NEO4J_PASSWORD_PATH: '/run/secrets/etl-neo4j-password'
      MYSQL_USER_PATH: '/run/secrets/mysql-etl-user'
      MYSQL_PASSWORD_PATH: '/run/secrets/mysql-etl-password'
#  elk-setup:
#    environment:
#      LOGSTASH_PASSWORD_PATH: '/run/secrets/logstash-keystore-password'
#      MYSQL_USER_PATH: '/run/secrets/mysql-logstash-user'
#      MYSQL_PASSWORD_PATH: '/run/secrets/mysql-logstash-password'
#      KIBANA_PASSWORD_PATH: '/run/secrets/elasticsearch-kibana-password'
#      BOOTSTRAP_PATH: '/run/secrets/elastic-bootstrap-password'
#      ELASTIC_PATH: '/run/secrets/elastic-password'