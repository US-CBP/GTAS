version: '3.7'
services:
  web-app:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          memory: 2G
    environment:
      DB_HOST: mariadb
      SP_SPRING_MAIL_USERNAME: "test.user@testdomain.com"
      SP_SPRING_MAIL_PASSWORD: "testpassword"
      SP_SPRING_MAIL_HOST: "some.smtp.testdomain.com"
      SP_SPRING_MAIL_PROPERTIES_SSL_TRUST_HOST: "testhost"
      SP_EMAIL_HIT_NOTIFICATION_ENABLED: "false"
      SP_ENABLE_EMAIL_NOTIFICATION_SERVICE: "false"
      SP_ADDITIONAL_PROCESSING_ENABLED_PASSENGER: "false"
      SP_ADDITIONAL_PROCESSING_ENABLED_RAW: "false"
      SP_ADDITIONAL_PROCESSING_ENABLED_RULES: "false"
      SP_RESET_LINK_URL: "https://localhost:443/password-reset"
      SP_RESET_PASSWORD_LINK_URL: "https://localhost:443/reset-password"
      SP_HIBERNATE_CONNECTION_URL: "jdbc:mariadb://mariadb:3306/gtas?useUnicode=true&characterEncoding=UTF-8&createDatabaseIfNotExist=true"
  rule-runner:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          memory: 2G
    environment:
      MARIA_URL: mariadb
      DB_HOST: mariadb
      MARIA_USERNAME: root
      MARIA_PASSWORD: admin
      UI_ADDRESS: localhost
      ACTIVE_MQ_HOST: activemq
  activemq:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          memory: 1G
    ports:
      - 61616:61616
      - 8161:8161      
  gtas-scheduler:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          memory: 2G
    environment:
      DB_HOST: mariadb
      SP_SPRING_MAIL_USERNAME: "some.user@somedomain.com"
      SP_SPRING_MAIL_PASSWORD: "somepassword"
      SP_SPRING_MAIL_HOST: "some.smtp.somedomain.com"
      SP_SPRING_MAIL_PROPERTIES_SSL_TRUST_HOST: "bogus"
      SP_EMAIL_HIT_NOTIFICATION_ENABLED: "false"
      SP_ENABLE_EMAIL_NOTIFICATION_SERVICE: "false"
      SP_ADDITIONAL_PROCESSING_ENABLED_PASSENGER: "false"
      SP_ADDITIONAL_PROCESSING_ENABLED_RAW: "false"
      SP_ADDITIONAL_PROCESSING_ENABLED_RULES: "false"
      SP_RESET_LINK_URL: "https://localhost:443/password-reset"
      SP_RESET_PASSWORD_LINK_URL: "https://localhost:443/reset-password"
      SP_HIBERNATE_CONNECTION_URL: "jdbc:mariadb://mariadb:3306/gtas?useUnicode=true&characterEncoding=UTF-8&createDatabaseIfNotExist=true"
    volumes:
      - type: bind
        source: ./gtas-data
        target: /usr/local/gtas-data
        consistency: consistent
  neo4j:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          memory: 2G
    environment:
      NEO4J_AUTH: "neo4j/admin"
      NEO4J_dbms_connector_bolt_advertised__address: localhost:7687
      NEO4J_dbms_connectors_default__advertised__address: localhost
  gtas-loader:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          memory: 2G
    environment:
      MARIA_URL: mariadb
      MARIA_USERNAME: root
      MARIA_PASSWORD: admin
      ACTIVE_MQ_HOST: activemq
    volumes:
      - type: bind
        source: ./gtas-data
        target: /usr/local/gtas-data
        consistency: consistent 
  elasticsearch:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          memory: 4G
  logstash:
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          memory: 4G
  kibana:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 500M
        reservations:
          memory: 500M
  mariadb:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          memory: 2G
  etl-job:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          memory: 2G
secrets:
  kibana-crt:
    file: ./gtas-parent/gtas-commons/certs/kibana.crt
  kibana-key:
    file: ./gtas-parent/gtas-commons/certs/kibana.key
